[gd_scene load_steps=47 format=3 uid="uid://et8e2bm1xmp0"]

[ext_resource type="Script" uid="uid://yvlgjjkmf4r4" path="res://scripts/entity.gd" id="1_h26si"]
[ext_resource type="PackedScene" uid="uid://b7waqubcb7n78" path="res://assets/models/rockguy.glb" id="1_rnoex"]
[ext_resource type="PackedScene" uid="uid://dyriga41qx3tc" path="res://scenes/health_bar.tscn" id="1_ut6rd"]
[ext_resource type="Resource" uid="uid://b4r30ackgoyfn" path="res://resources/enemies/rockguy.tres" id="2_aeadu"]
[ext_resource type="PackedScene" uid="uid://c1lk6txvhrx56" path="res://scenes/components/throw_stuff_component.tscn" id="5_aeadu"]
[ext_resource type="PackedScene" uid="uid://bhyt1i03ujdvu" path="res://scenes/rock.tscn" id="6_l7lrj"]
[ext_resource type="Script" uid="uid://cmgcelj1qxg8o" path="res://addons/tattomoosa.vision_cone_3d/src/VisionCone3D.gd" id="7_l7lrj"]
[ext_resource type="Script" uid="uid://bqmbdfikehh8s" path="res://scenes/enemy_ai/rockguyai.gd" id="8_8bdg2"]
[ext_resource type="Script" uid="uid://cf3ajn1p71af3" path="res://ai/tasks/stand_idle.gd" id="9_8fhss"]
[ext_resource type="Script" uid="uid://c0r6gjup4rrgq" path="res://ai/tasks/go_towards_target.gd" id="11_82e6l"]
[ext_resource type="Script" uid="uid://dwa880sagwt70" path="res://ai/tasks/throw.gd" id="12_8bdg2"]
[ext_resource type="Script" uid="uid://chtqbnjed8vmf" path="res://ai/tasks/perform_attack.gd" id="12_e0h68"]
[ext_resource type="Script" uid="uid://bjc5oqrcd06bx" path="res://ai/tasks/perform_animation.gd" id="13_nnmbj"]
[ext_resource type="PackedScene" uid="uid://deqpan4silm2n" path="res://scenes/utils/ui_marker/waypoint.tscn" id="15_8bdg2"]
[ext_resource type="Script" uid="uid://bs28s835akfx" path="res://ai/tasks/fall.gd" id="15_qx8oa"]

[sub_resource type="CapsuleShape3D" id="CapsuleShape3D_rnoex"]
radius = 0.180933
height = 1.47242

[sub_resource type="AnimationNodeAnimation" id="AnimationNodeAnimation_rnoex"]
animation = &"run"

[sub_resource type="AnimationNodeAnimation" id="AnimationNodeAnimation_ut6rd"]
animation = &"attack"

[sub_resource type="AnimationNodeAnimation" id="AnimationNodeAnimation_vgy5b"]
animation = &"idle"

[sub_resource type="AnimationNodeTimeScale" id="AnimationNodeTimeScale_h26si"]

[sub_resource type="AnimationNodeTransition" id="AnimationNodeTransition_rnoex"]
input_0/name = "idle"
input_0/auto_advance = false
input_0/break_loop_at_end = false
input_0/reset = true
input_1/name = "walk"
input_1/auto_advance = false
input_1/break_loop_at_end = false
input_1/reset = true
input_2/name = "attack"
input_2/auto_advance = false
input_2/break_loop_at_end = false
input_2/reset = true

[sub_resource type="AnimationNodeBlendTree" id="AnimationNodeBlendTree_ut6rd"]
graph_offset = Vector2(-286.367, 137.358)
nodes/Animation/node = SubResource("AnimationNodeAnimation_vgy5b")
nodes/Animation/position = Vector2(520, 140)
"nodes/Animation 2/node" = SubResource("AnimationNodeAnimation_rnoex")
"nodes/Animation 2/position" = Vector2(380, 340)
"nodes/Animation 3/node" = SubResource("AnimationNodeAnimation_ut6rd")
"nodes/Animation 3/position" = Vector2(440, 540)
nodes/TimeScale/node = SubResource("AnimationNodeTimeScale_h26si")
nodes/TimeScale/position = Vector2(580, 340)
nodes/Transition/node = SubResource("AnimationNodeTransition_rnoex")
nodes/Transition/position = Vector2(775, 189)
nodes/output/position = Vector2(1020, 220)
node_connections = [&"TimeScale", 0, &"Animation 2", &"Transition", 0, &"Animation", &"Transition", 1, &"TimeScale", &"Transition", 2, &"Animation 3", &"output", 0, &"Transition"]

[sub_resource type="BlackboardPlan" id="BlackboardPlan_0miy2"]
var/target/name = &"target"
var/target/type = 24
var/target/hint = 0
var/target/hint_string = ""
var/patrol_point_idx/name = &"patrol_point_idx"
var/patrol_point_idx/type = 2
var/patrol_point_idx/value = 0
var/patrol_point_idx/hint = 0
var/patrol_point_idx/hint_string = ""
var/last_known_target_position/name = &"last_known_target_position"
var/last_known_target_position/type = 9
var/last_known_target_position/value = Vector3(0, 0, 0)
var/last_known_target_position/hint = 0
var/last_known_target_position/hint_string = ""

[sub_resource type="BlackboardPlan" id="BlackboardPlan_14u3r"]

[sub_resource type="BTAction" id="BTAction_3cm67"]
script = ExtResource("9_8fhss")
idle_anim_tree_state = &"idle"

[sub_resource type="BTRepeat" id="BTRepeat_c7bgd"]
forever = true
children = [SubResource("BTAction_3cm67")]

[sub_resource type="BehaviorTree" id="BehaviorTree_8bdg2"]
blackboard_plan = SubResource("BlackboardPlan_14u3r")
root_task = SubResource("BTRepeat_c7bgd")

[sub_resource type="BlackboardPlan" id="BlackboardPlan_8awrx"]

[sub_resource type="BlackboardPlan" id="BlackboardPlan_1dt6r"]
var/distance_to_target/name = &"distance_to_target"
var/distance_to_target/type = 3
var/distance_to_target/value = 0.0
var/distance_to_target/hint = 0
var/distance_to_target/hint_string = ""

[sub_resource type="BTAction" id="BTAction_8bdg2"]
script = ExtResource("11_82e6l")
min_distance = 30.0
move_anim_tree_state = &"walk"
run_away = true
use_root_motion = false

[sub_resource type="BBVariant" id="BBVariant_8fhss"]
type = 3
saved_value = 28.0
resource_name = "28.0"

[sub_resource type="BTCheckVar" id="BTCheckVar_n6jye"]
variable = &"distance_to_target"
check_type = 4
value = SubResource("BBVariant_8fhss")

[sub_resource type="BTAction" id="BTAction_82e6l"]
script = ExtResource("12_e0h68")
attack_anim_tree_state = &"attack"
final_attack_anim_name = &"attack"

[sub_resource type="BTAction" id="BTAction_8fhss"]
script = ExtResource("12_8bdg2")

[sub_resource type="BTSequence" id="BTSequence_8bdg2"]
children = [SubResource("BTAction_82e6l"), SubResource("BTAction_8fhss")]

[sub_resource type="BTAction" id="BTAction_e0h68"]
script = ExtResource("13_nnmbj")
anim_tree_state = &"idle"
final_anim_name = &"idle"

[sub_resource type="BTTimeLimit" id="BTTimeLimit_nnmbj"]
time_limit = 0.5
children = [SubResource("BTAction_e0h68")]

[sub_resource type="BTSequence" id="BTSequence_okhdf"]
children = [SubResource("BTCheckVar_n6jye"), SubResource("BTSequence_8bdg2"), SubResource("BTTimeLimit_nnmbj")]

[sub_resource type="BTAlwaysSucceed" id="BTAlwaysSucceed_qx8oa"]
children = [SubResource("BTSequence_okhdf")]

[sub_resource type="BTSequence" id="BTSequence_0miy2"]
children = [SubResource("BTAction_8bdg2"), SubResource("BTAlwaysSucceed_qx8oa")]

[sub_resource type="BehaviorTree" id="BehaviorTree_n5uhp"]
blackboard_plan = SubResource("BlackboardPlan_1dt6r")
root_task = SubResource("BTSequence_0miy2")

[sub_resource type="BlackboardPlan" id="BlackboardPlan_yf0ng"]

[sub_resource type="BlackboardPlan" id="BlackboardPlan_w8y5l"]

[sub_resource type="BTAction" id="BTAction_nw3uw"]
script = ExtResource("15_qx8oa")
fall_anim_tree_state = &""
velocity_to_take_damage = 15.0
damage_taken = 1000.0

[sub_resource type="BehaviorTree" id="BehaviorTree_og3cf"]
blackboard_plan = SubResource("BlackboardPlan_w8y5l")
root_task = SubResource("BTAction_nw3uw")

[sub_resource type="BlackboardPlan" id="BlackboardPlan_nvfmh"]

[node name="RockGuy" type="CharacterBody3D" node_paths=PackedStringArray("animation_tree", "model", "hp_bar", "vision_cone") groups=["knights"]]
collision_layer = 2
collision_mask = 3
script = ExtResource("1_h26si")
animation_tree = NodePath("AnimationTree")
model = NodePath("rockguy")
entity_stats = ExtResource("2_aeadu")
hp_bar = NodePath("HealthBar")
antagonist_groups = Array[StringName]([&"player", &"animals"])
vision_cone = NodePath("rockguy/VisionCone3D")

[node name="TextDebug" parent="." instance=ExtResource("15_8bdg2")]
unique_name_in_owner = true

[node name="HealthBar" parent="." instance=ExtResource("1_ut6rd")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1.64071, 0)

[node name="ThrowStuffComponent" parent="." node_paths=PackedStringArray("agent", "starting_point") instance=ExtResource("5_aeadu")]
agent = NodePath("..")
projectile_scene = ExtResource("6_l7lrj")
starting_point = NodePath("../rockguy/Marker3D")

[node name="rockguy" parent="." instance=ExtResource("1_rnoex")]

[node name="Skeleton3D" parent="rockguy/metarig" index="0"]
bones/1/position = Vector3(4.22277e-15, -0.0552, 0.683739)
bones/1/rotation = Quaternion(-4.28462e-08, 0.823363, 0.567515, -6.21622e-08)
bones/9/rotation = Quaternion(0.434417, 0.485878, -0.500966, 0.569418)
bones/10/rotation = Quaternion(0.00247957, -0.0533742, -0.00040776, 0.998571)
bones/11/rotation = Quaternion(-0.110869, 0.0840147, 0.187538, 0.972358)
bones/13/rotation = Quaternion(0.434417, -0.485878, 0.500966, 0.569418)
bones/14/rotation = Quaternion(0.00247955, 0.0533742, 0.00040776, 0.998571)
bones/15/rotation = Quaternion(-0.110869, -0.0840148, -0.187538, 0.972358)
bones/16/rotation = Quaternion(0.971743, -1.3007e-08, 3.47337e-08, 0.236043)
bones/17/rotation = Quaternion(0.128701, -1.15059e-07, 8.62117e-09, 0.991683)
bones/18/rotation = Quaternion(-0.577647, 5.2423e-07, -2.03571e-07, 0.816287)
bones/19/rotation = Quaternion(-1.48793e-08, 0.970804, -0.239875, 3.85951e-07)
bones/20/rotation = Quaternion(0.971743, -4.62724e-08, 1.26143e-07, 0.236043)
bones/21/rotation = Quaternion(0.128701, 1.13448e-07, -2.10346e-08, 0.991683)
bones/22/rotation = Quaternion(-0.577647, -5.27052e-07, 1.87792e-07, 0.816287)
bones/23/rotation = Quaternion(9.07327e-08, 0.970804, -0.239875, -3.67208e-07)
bones/25/position = Vector3(0.44194, -0.423362, 0.167628)
bones/25/rotation = Quaternion(0.488416, -0.0972926, -0.793176, 0.350508)
bones/26/position = Vector3(0.778671, 0.212874, -0.276561)
bones/27/position = Vector3(-0.44194, -0.423362, 0.167628)
bones/27/rotation = Quaternion(0.488416, 0.0972927, 0.793176, 0.350508)
bones/28/position = Vector3(-0.77867, 0.212873, -0.276562)
bones/29/position = Vector3(-0.098, -0.0500049, -8.28975e-16)
bones/31/rotation = Quaternion(-1.04847e-08, 0.970804, 0.239874, 4.24352e-08)
bones/32/rotation = Quaternion(-4.76835e-07, -7.30862e-22, 1, -3.70652e-14)
bones/35/position = Vector3(0.098, -0.0500049, -8.28975e-16)
bones/37/rotation = Quaternion(1.04847e-08, 0.970804, 0.239874, -4.24352e-08)

[node name="AnimationPlayer" parent="rockguy" index="1"]
active = false
root_motion_track = NodePath("metarig/Skeleton3D:root")
root_motion_local = false
callback_mode_process = 0

[node name="Marker3D" type="Marker3D" parent="rockguy"]
transform = Transform3D(1, 0, 0, 0, 0.707107, 0.707107, 0, -0.707107, 0.707107, 0, 1.93907, 1.36366)
gizmo_extents = 4.05

[node name="VisionCone3D" type="Area3D" parent="rockguy" node_paths=PackedStringArray("vision_test_ignore_bodies")]
transform = Transform3D(-1, 0, -8.74228e-08, 0, 1, 0, 8.74228e-08, 0, -1, 0, 1.24856, 0.368641)
collision_layer = 0
collision_mask = 2
script = ExtResource("7_l7lrj")
range = 34.075
debug_draw = true
vision_test_mode = 0
vision_test_ignore_bodies = [NodePath("../..")]
collision_layer_ = 0
collision_mask_ = 2
metadata/_custom_type_script = "uid://cmgcelj1qxg8o"

[node name="CollisionShape3D" type="CollisionShape3D" parent="."]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0.736212, 0)
shape = SubResource("CapsuleShape3D_rnoex")

[node name="AnimationTree" type="AnimationTree" parent="."]
root_node = NodePath("../rockguy")
root_motion_track = NodePath("metarig/Skeleton3D:root")
root_motion_local = false
callback_mode_process = 0
tree_root = SubResource("AnimationNodeBlendTree_ut6rd")
anim_player = NodePath("../rockguy/AnimationPlayer")
parameters/TimeScale/scale = 2.0
parameters/Transition/current_state = "idle"
parameters/Transition/transition_request = ""
parameters/Transition/current_index = 0

[node name="LimboHSM" type="LimboHSM" parent="." node_paths=PackedStringArray("character")]
unique_name_in_owner = true
script = ExtResource("8_8bdg2")
character = NodePath("..")

[node name="Alive" type="LimboHSM" parent="LimboHSM"]
unique_name_in_owner = true

[node name="Onground" type="LimboHSM" parent="LimboHSM/Alive"]
blackboard_plan = SubResource("BlackboardPlan_0miy2")
unique_name_in_owner = true

[node name="Patrol" type="BTState" parent="LimboHSM/Alive/Onground"]
behavior_tree = SubResource("BehaviorTree_8bdg2")
blackboard_plan = SubResource("BlackboardPlan_8awrx")
unique_name_in_owner = true

[node name="Attack" type="BTState" parent="LimboHSM/Alive/Onground"]
behavior_tree = SubResource("BehaviorTree_n5uhp")
failure_event = &"target_lost"
blackboard_plan = SubResource("BlackboardPlan_yf0ng")
unique_name_in_owner = true

[node name="Falling" type="BTState" parent="LimboHSM/Alive"]
behavior_tree = SubResource("BehaviorTree_og3cf")
success_event = &"landed"
failure_event = &"landed"
blackboard_plan = SubResource("BlackboardPlan_nvfmh")
unique_name_in_owner = true

[node name="Dead" type="LimboState" parent="LimboHSM"]
unique_name_in_owner = true

[editable path="rockguy"]
